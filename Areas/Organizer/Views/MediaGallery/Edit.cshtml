@model EventSphere.Models.entities.TblMediaGallery
@{
    Layout = "~/Areas/Organizer/Views/Shared/_LayoutOrganizer.cshtml";
}

<h3>Edit Media</h3>

<form id="editMediaForm" enctype="multipart/form-data">
    <input type="hidden" name="Id" value="@Model.Id" />

    <div class="mb-3">
        <label>Event:</label>
        <select name="EventId" class="form-select" required>
            @foreach (var e in ViewBag.Events)
            {
                <option value="@e.Id" @(e.Id == Model.EventId ? "selected" : "")>@e.Title</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <label>Uploader:</label>
        <select name="UploadedBy" class="form-select" required>
            @foreach (var u in ViewBag.Users)
            {
                <option value="@u.Id" @(u.Id == Model.UploadedBy ? "selected" : "")>@u.Email</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <label>File Type:</label>
        <select name="FileType" class="form-select" required>
            <option value="1" @(Model.FileType == 1 ? "selected" : "")>Image</option>
            <option value="2" @(Model.FileType == 2 ? "selected" : "")>Video</option>
        </select>
    </div>

    <div class="mb-3">
        <label>Caption:</label>
        <input type="text" name="Caption" class="form-control" value="@Model.Caption" />
    </div>

    <div class="mb-3">
        <label>Upload File:</label>
        <input type="file" name="file" class="form-control" />
        @if (!string.IsNullOrEmpty(Model.FileUrl))
        {
            <div class="mt-2">
                @if (Model.FileType == 1)
                {
                    <img src="@Model.FileUrl" width="200" />
                }
                else
                {
                    <video width="200" controls>
                        <source src="@Model.FileUrl" type="video/mp4">
                    </video>
                }
            </div>
        }
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success">Save</button>
        <a href="@Url.Action("Index", "MediaGallery", new { area = "Organizer" })" class="btn btn-secondary">Cancel</a>
    </div>
</form>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function(){
            var fileInput = $('#editMediaForm input[name="file"]')[0];
            var fileTypeSelect = $('#editMediaForm select[name="FileType"]');
            var originalFileType = fileTypeSelect.val(); 

            function validateFileInput(fileInput, fileType) {
                if(fileInput.files.length === 0){
               
                    var existingFileType = originalFileType;
                    if(fileType !== existingFileType){
                        alert('You changed File Type, must select new file!');
                        return false;
                    }
                    return true; 
                }

                var file = fileInput.files[0];
                var allowedImage = ['image/jpeg','image/png','image/gif'];
                var allowedVideo = ['video/mp4','video/quicktime','video/x-msvideo'];

                if(fileType == '1' && !allowedImage.includes(file.type)) {
                    alert('File must be a valid image (.jpg, .png, .gif)!');
                    fileInput.value = '';
                    return false;
                }
                if(fileType == '2' && !allowedVideo.includes(file.type)) {
                    alert('File must be a valid video (.mp4, .mov, .avi)!');
                    fileInput.value = '';
                    return false;
                }
                return true;
            }

            // Kiểm tra khi submit
            $('#editMediaForm').submit(function(e){
                e.preventDefault();
                var fileType = fileTypeSelect.val();

                if(!validateFileInput(fileInput, fileType)) return;

                var formData = new FormData(this);
                $.ajax({
                    url: '/Organizer/MediaGallery/EditAjax',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(res){
                        if(res.success){
                            alert('Update success!');
                            window.location.href = '/Organizer/MediaGallery/Index';
                        } else {
                            alert('Error: ' + (res.message || ""));
                        }
                    }
                });
            });

   
            fileTypeSelect.change(function(){
                var fileType = $(this).val();
                if(fileInput.files.length > 0){
                    validateFileInput(fileInput, fileType);
                }
            });
        });
    </script>

}


